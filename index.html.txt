<!-- External Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lato:wght@400;700&display=swap" rel="stylesheet">

<!-- Custom Styles -->
<style>
    #dcc-generator-container * {
        box-sizing: border-box;
    }
    #dcc-generator-container {
        font-family: 'Lato', sans-serif;
        color: #fff;
    }
    #dcc-generator-container h1, 
    #dcc-generator-container h2, 
    #dcc-generator-container h3, 
    #dcc-generator-container h4 {
        font-family: 'Cinzel', serif;
        margin: 0;
    }
    #dcc-card-preview {
        border: 10px solid #a1887f;
        border-image: linear-gradient(to bottom right, #6d4c41, #d7ccc8, #6d4c41) 1;
        box-shadow: 0 0 20px rgba(0,0,0,.5);
        aspect-ratio: 55 / 85;
    }
    #dcc-preview-image-container, 
    #dcc-preview-pet-image {
        background-size: cover;
        background-position: center center;
        background-repeat: no-repeat;
    }
    #dcc-generator-container .dcc-full-bg-active #dcc-card-content-wrapper .dcc-content-box {
         background-color: rgba(245, 240, 225, 0.85) !important;
         backdrop-filter: blur(2px);
    }
</style>

<!-- HTML Structure -->
<div id="dcc-generator-container">
    <div style="max-width: 80rem; margin-left: auto; margin-right: auto;">
        <header style="text-align: center; margin-bottom: 2rem;">
            <h1 style="font-size: 2.25rem; line-height: 2.5rem; color: #fbbf24;">Dungeon Crawler Card Generator</h1>
            <p style="color: #9ca3af; margin-top: 0.5rem;">Create your own Crawler card based on the world of Dungeon Crawler Carl.</p>
        </header>

        <div style="display: flex; flex-direction: column; gap: 2rem;">
            <!-- Left Side: Form Controls -->
            <div style="background-color: #1f2937; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); width: 100%; max-width: 32rem; margin: auto;">
                <h2 style="font-size: 1.5rem; line-height: 2rem; color: #fbbf24; border-bottom: 2px solid rgba(251, 191, 36, 0.3); padding-bottom: 0.5rem; margin-bottom: 1rem;">Crawler Details</h2>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div><label for="dcc-crawlerName" style="display: block; font-size: 0.875rem; font-weight: 700; color: #fcd34d; margin-bottom: 0.25rem;">Crawler Name</label><input type="text" id="dcc-crawlerName" style="width: 100%; background-color: #374151; color: #fff; border: 1px solid #4B5563; border-radius: 0.375rem; padding: 0.5rem;" placeholder="e.g., Princess Donut"></div>
                    <div><label for="dcc-crawlerNickname" style="display: block; font-size: 0.875rem; font-weight: 700; color: #fcd34d; margin-bottom: 0.25rem;">Nickname / Title</label><input type="text" id="dcc-crawlerNickname" style="width: 100%; background-color: #374151; color: #fff; border: 1px solid #4B5563; border-radius: 0.375rem; padding: 0.5rem;" placeholder="e.g., The Queen Anne Chonk"></div>
                    <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 1rem;">
                        <div><label for="dcc-crawlerNumber" style="display: block; font-size: 0.875rem; font-weight: 700; color: #fcd34d; margin-bottom: 0.25rem;">Crawler #</label><input type="text" id="dcc-crawlerNumber" style="width: 100%; background-color: #374151; color: #fff; border: 1px solid #4B5563; border-radius: 0.375rem; padding: 0.5rem;" placeholder="e.g., #4,119"></div>
                        <div><label for="dcc-crawlerLevel" style="display: block; font-size: 0.875rem; font-weight: 700; color: #fcd34d; margin-bottom: 0.25rem;">Level</label><input type="number" id="dcc-crawlerLevel" style="width: 100%; background-color: #374151; color: #fff; border: 1px solid #4B5563; border-radius: 0.375rem; padding: 0.5rem;" value="1"></div>
                    </div>
                     <div><label for="dcc-crawlerRace" style="display: block; font-size: 0.875rem; font-weight: 700; color: #fcd34d; margin-bottom: 0.25rem;">Race</label><input type="text" id="dcc-crawlerRace" style="width: 100%; background-color: #374151; color: #fff; border: 1px solid #4B5563; border-radius: 0.375rem; padding: 0.5rem;" placeholder="e.g., Persian Cat"></div>
                    <div>
                        <label for="dcc-crawlerClass" style="display: block; font-size: 0.875rem; font-weight: 700; color: #fcd34d; margin-bottom: 0.25rem;">Class</label><input type="text" id="dcc-crawlerClass" style="width: 100%; background-color: #374151; color: #fff; border: 1px solid #4B5563; border-radius: 0.375rem; padding: 0.5rem;" placeholder="e.g., Former Child Actress">
                        <div style="display: flex; align-items: center; margin-top: 0.5rem;"><input id="dcc-hasClass" type="checkbox"><label for="dcc-hasClass" style="margin-left: 0.5rem; font-size: 0.875rem; color: #d1d5db;">Has Subclass?</label></div>
                        <div id="dcc-subclass-details" style="display: none; margin-top: 0.5rem;"><label for="dcc-crawlerSubclass" style="display: block; font-size: 0.875rem; font-weight: 700; color: #fcd34d; margin-bottom: 0.25rem;">Subclass</label><input type="text" id="dcc-crawlerSubclass" style="width: 100%; background-color: #374151; color: #fff; border: 1px solid #4B5563; border-radius: 0.375rem; padding: 0.5rem;" placeholder="e.g., Legendary Diva"></div>
                    </div>
                    <div>
                        <label for="dcc-imageUpload" style="display: block; font-size: 0.875rem; font-weight: 700; color: #fcd34d; margin-bottom: 0.25rem;">Character Image</label>
                        <label for="dcc-imageUpload" style="width: 100%; display: inline-block; text-align: center; background-color: #4b5563; color: #fff; font-weight: 700; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer;">Upload Image</label>
                        <input type="file" id="dcc-imageUpload" style="display: none;" accept="image/*">
                        <input type="hidden" id="dcc-imageUrl">
                        <p style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">For best results, use a landscape-style image (e.g., 4:3 ratio).</p>
                    </div>
                    <div id="dcc-image-adjust-controls" style="display: none; flex-direction: column; gap: 0.75rem; padding-top: 0.75rem;">
                         <h3 style="font-size: 1.25rem; color: #fbbf24; border-bottom: 1px solid rgba(251, 191, 36, 0.2); padding-bottom: 0.25rem;">Image Adjustments</h3>
                         <div style="display: flex; align-items: center;"><input id="dcc-fullBgImage" type="checkbox"><label for="dcc-fullBgImage" style="margin-left: 0.5rem; font-size: 0.875rem; color: #d1d5db;">Use as Full Background</label></div>
                         <div><label for="dcc-imageZoom" style="display: block; font-size: 0.875rem; font-weight: 700; color: #fcd34d; margin-bottom: 0.25rem;">Zoom</label><input type="range" id="dcc-imageZoom" min="50" max="300" value="100" step="1" style="width: 100%;"></div>
                         <div><label for="dcc-imagePanX" style="display: block; font-size: 0.875rem; font-weight: 700; color: #fcd34d; margin-bottom: 0.25rem;">Pan Left/Right</label><input type="range" id="dcc-imagePanX" min="0" max="100" value="50" step="1" style="width: 100%;"></div>
                         <div><label for="dcc-imagePanY" style="display: block; font-size: 0.875rem; font-weight: 700; color: #fcd34d; margin-bottom: 0.25rem;">Pan Up/Down</label><input type="range" id="dcc-imagePanY" min="0" max="100" value="50" step="1" style="width: 100%;"></div>
                         <button id="dcc-resetImageBtn" style="width: 100%; font-size: 0.875rem; background-color: #4b5563; padding: 0.25rem 1rem; border-radius: 0.5rem;">Reset Image</button>
                    </div>
                    <h3 style="font-size: 1.25rem; color: #fbbf24; border-bottom: 1px solid rgba(251, 191, 36, 0.2); padding-top: 1rem; padding-bottom: 0.25rem;">Primary Stats</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 1rem 1.5rem;">
                        <div><label for="dcc-statStr" style="display: block; font-size: 0.875rem; font-weight: 700; color: #fcd34d; margin-bottom: 0.25rem;">Strength</label><input type="number" id="dcc-statStr" class="dcc-form-input" value="10"></div>
                        <div><label for="dcc-statDex" style="display: block; font-size: 0.875rem; font-weight: 700; color: #fcd34d; margin-bottom: 0.25rem;">Dexterity</label><input type="number" id="dcc-statDex" class="dcc-form-input" value="10"></div>
                        <div><label for="dcc-statCon" style="display: block; font-size: 0.875rem; font-weight: 700; color: #fcd34d; margin-bottom: 0.25rem;">Constitution</label><input type="number" id="dcc-statCon" class="dcc-form-input" value="10"></div>
                        <div><label for="dcc-statInt" style="display: block; font-size: 0.875rem; font-weight: 700; color: #fcd34d; margin-bottom: 0.25rem;">Intelligence</label><input type="number" id="dcc-statInt" class="dcc-form-input" value="10"></div>
                        <div><label for="dcc-statWis" style="display: block; font-size: 0.875rem; font-weight: 700; color: #fcd34d; margin-bottom: 0.25rem;">Wisdom</label><input type="number" id="dcc-statWis" class="dcc-form-input" value="10"></div>
                        <div><label for="dcc-statCha" style="display: block; font-size: 0.875rem; font-weight: 700; color: #fcd34d; margin-bottom: 0.25rem;">Charisma</label><input type="number" id="dcc-statCha" class="dcc-form-input" value="10"></div>
                    </div>
                    <div><label for="dcc-skills" style="display: block; font-size: 0.875rem; font-weight: 700; color: #fcd34d; margin-bottom: 0.25rem;">Skills / Perks / Mutations</label><textarea id="dcc-skills" class="dcc-form-textarea" rows="4" placeholder="• Clockwork Triplicate&#10;• Love Vampire&#10;• Cockroach"></textarea></div>
                    <h3 style="font-size: 1.25rem; color: #fbbf24; border-bottom: 1px solid rgba(251, 191, 36, 0.2); padding-top: 1rem; padding-bottom: 0.25rem;">Party & Companion</h3>
                    <div><label for="dcc-party" style="display: block; font-size: 0.875rem; font-weight: 700; color: #fcd34d; margin-bottom: 0.25rem;">Party Members</label><textarea id="dcc-party" class="dcc-form-textarea" rows="2" placeholder="e.g., The Royal Court of Princess Donut"></textarea></div>
                    <div style="display: flex; align-items: center; margin-top: 0.5rem;"><input id="dcc-hasPet" type="checkbox"><label for="dcc-hasPet" style="margin-left: 0.5rem; font-size: 0.875rem; color: #d1d5db;">Has Pet / Companion?</label></div>
                    <div id="dcc-pet-details" style="display: none; margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem;">
                        <div><label for="dcc-petName" style="display: block; font-size: 0.875rem; font-weight: 700; color: #fcd34d; margin-bottom: 0.25rem;">Pet Name</label><input type="text" id="dcc-petName" class="dcc-form-input" placeholder="e.g., Mongo"></div>
                        <div style="display: flex; align-items: center;"><input id="dcc-addPetImage" type="checkbox"><label for="dcc-addPetImage" style="margin-left: 0.5rem; font-size: 0.875rem; color: #d1d5db;">Add Pet Image?</label></div>
                        <div id="dcc-pet-image-url-container" style="display: none;">
                            <label for="dcc-petImageUpload" style="display: block; font-size: 0.875rem; font-weight: 700; color: #fcd34d; margin-bottom: 0.25rem;">Pet Image</label>
                            <label for="dcc-petImageUpload" class="dcc-upload-label">Upload Pet Image</label>
                            <input type="file" id="dcc-petImageUpload" style="display: none;" accept="image/*">
                            <input type="hidden" id="dcc-petImageUrl">
                        </div>
                    </div>
                    <div><label for="dcc-catchphrase" style="display: block; font-size: 0.875rem; font-weight: 700; color: #fcd34d; margin-bottom: 0.25rem;">Catchphrase / Quote</label><textarea id="dcc-catchphrase" class="dcc-form-textarea" rows="2" placeholder="e.g., &quot;Mongo is Appalled&quot;"></textarea></div>
                </div>
                <div style="margin-top: 2rem; display: flex; justify-content: center;">
                    <button id="dcc-downloadBtn" style="width: 100%; background-color: #d97706; color: #fff; font-weight: 700; padding: 0.5rem 1rem; border-radius: 0.5rem;">Download Card</button>
                </div>
            </div>

            <div style="width: 100%; display: flex; justify-content: center; align-items: flex-start;">
                <div id="dcc-card-preview" style="width: 100%; max-width: 24rem; background-color: #e0d6c6; padding: 0.25rem; border-radius: 0.5rem;">
                    <div id="dcc-card-content-wrapper" style="padding: 1rem; border-radius: 0.375rem; background-color: #f5f0e1;">
                        <header id="dcc-preview-header" style="text-align: center; border-bottom: 4px double #a1887f; padding-bottom: 0.5rem; margin-bottom: 1rem; flex-shrink: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: baseline;"><p id="dcc-preview-crawlerNumber" style="color: #8d6e63;">CRAWLER #1234</p><p id="dcc-preview-crawlerLevel" style="color: #8d6e63;">LEVEL 1</p></div>
                            <h2 id="dcc-preview-crawlerName" style="font-size: 1.5rem; line-height: 1.75rem; color: #5d4037;">Character Name</h2>
                            <p id="dcc-preview-crawlerNickname" style="font-weight: 700; color: #8d6e63;">Nickname</p>
                        </header>
                        <div id="dcc-preview-image-container" style="flex-basis: 40%; margin-bottom: 1rem; border-radius: 0.375rem; background-color: #d1d5db;"></div>
                        <div style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 1rem; flex-shrink: 0;">
                            <div style="grid-column: span 4; background-color: rgba(224, 214, 198, 0.7); padding: 0.5rem; border-radius: 0.5rem;" class="dcc-content-box">
                                <ul style="font-size: 0.875rem; display: flex; flex-direction: column; gap: 0.25rem; font-weight: 700; color: #1f2937;">
                                    <li style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem;"><span>STR</span><span id="dcc-preview-statStr" style="text-align: right;">10</span></li>
                                    <li style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem;"><span>DEX</span><span id="dcc-preview-statDex" style="text-align: right;">10</span></li>
                                    <li style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem;"><span>CON</span><span id="dcc-preview-statCon" style="text-align: right;">10</span></li>
                                    <li style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem;"><span>INT</span><span id="dcc-preview-statInt" style="text-align: right;">10</span></li>
                                    <li style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem;"><span>WIS</span><span id="dcc-preview-statWis" style="text-align: right;">10</span></li>
                                    <li style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem;"><span>CHA</span><span id="dcc-preview-statCha" style="text-align: right;">10</span></li>
                                </ul>
                            </div>
                            <div style="grid-column: span 8; display: flex; flex-direction: column; gap: 0.5rem;">
                                <div class="dcc-content-box" style="padding: 0.5rem; border-radius: 0.5rem;">
                                    <h4 style="color: #8d6e63;">RACE & CLASS</h4>
                                    <div style="height: 1px; background-color: rgba(161, 136, 127, 0.5); margin: 0.25rem 0;"></div>
                                    <p id="dcc-preview-crawlerRace" style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">Race</p>
                                    <p id="dcc-preview-crawlerClass" style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">Class Name</p>
                                    <p id="dcc-preview-crawlerSubclass" style="font-size: 0.75rem; font-style: italic; color: #4b5563;"></p>
                                </div>
                                <div class="dcc-content-box" style="padding: 0.5rem; border-radius: 0.5rem;">
                                    <h4 style="color: #8d6e63;">SKILLS & PERKS</h4>
                                    <div style="height: 1px; background-color: rgba(161, 136, 127, 0.5); margin: 0.25rem 0;"></div>
                                    <p id="dcc-preview-skills" style="font-size: 0.75rem; white-space: pre-wrap; color: #1f2937;">Skills list here.</p>
                                </div>
                            </div>
                        </div>
                        <div id="dcc-preview-party-box" class="dcc-content-box" style="margin-top: 1rem; flex-shrink: 0; padding: 0.75rem; border-radius: 0.5rem;">
                            <h4 style="color: #8d6e63;">PARTY & COMPANION</h4>
                            <div style="height: 1px; background-color: rgba(161, 136, 127, 0.5); margin: 0.25rem 0;"></div>
                            <div id="dcc-preview-party-content" style="display: flex; align-items: center; gap: 0.75rem; padding-top: 0.25rem;">
                                <div id="dcc-preview-pet-image" style="width: 3rem; height: 3rem; border-radius: 9999px; background-color: rgba(156, 163, 175, 0.5); display: none; flex-shrink: 0; border: 2px solid rgba(107, 114, 128, 0.5);"></div>
                                <p id="dcc-preview-party" style="font-size: 0.875rem; font-weight: 600; white-space: pre-wrap; flex-grow: 1; color: #1f2937;">Party members here.</p>
                            </div>
                        </div>
                        <div id="dcc-preview-catchphrase" style="text-align: center; border-top: 2px solid #a1887f; padding-top: 0.5rem; font-weight: 600; font-style: italic; color: #6d4c41;">"Catchphrase goes here."</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript Logic -->
<script>
    const setupDccGenerator = () => {
        const dom = {
            petDetails: document.getElementById('dcc-pet-details'),
            hasPet: document.getElementById('dcc-hasPet'),
            addPetImage: document.getElementById('dcc-addPetImage'),
            petImageUrlContainer: document.getElementById('dcc-pet-image-url-container'),
            petImageUrl: document.getElementById('dcc-petImageUrl'),
            petImageUpload: document.getElementById('dcc-petImageUpload'),
            previewPetImage: document.getElementById('dcc-preview-pet-image'),
            subclassDetails: document.getElementById('dcc-subclass-details'),
            hasClass: document.getElementById('dcc-hasClass'),
            imageAdjustControls: document.getElementById('dcc-image-adjust-controls'),
            imageUrl: document.getElementById('dcc-imageUrl'),
            imageUpload: document.getElementById('dcc-imageUpload'),
            fullBgImage: document.getElementById('dcc-fullBgImage'),
            cardPreview: document.getElementById('dcc-card-preview'),
            imageContainer: document.getElementById('dcc-preview-image-container'),
            cardContentWrapper: document.getElementById('dcc-card-content-wrapper'),
            imageZoom: document.getElementById('dcc-imageZoom'),
            imagePanX: document.getElementById('dcc-imagePanX'),
            imagePanY: document.getElementById('dcc-imagePanY'),
        };

        const textFields = { 
            'dcc-crawlerName': 'dcc-preview-crawlerName', 
            'dcc-crawlerNickname': 'dcc-preview-crawlerNickname', 
            'dcc-crawlerNumber': 'dcc-preview-crawlerNumber', 
            'dcc-crawlerLevel': 'dcc-preview-crawlerLevel', 
            'dcc-crawlerRace': 'dcc-preview-crawlerRace', 
            'dcc-crawlerClass': 'dcc-preview-crawlerClass', 
            'dcc-crawlerSubclass': 'dcc-preview-crawlerSubclass', 
            'dcc-statStr': 'dcc-preview-statStr', 
            'dcc-statDex': 'dcc-preview-statDex', 
            'dcc-statCon': 'dcc-preview-statCon', 
            'dcc-statInt': 'dcc-preview-statInt', 
            'dcc-statWis': 'dcc-preview-statWis', 
            'dcc-statCha': 'dcc-preview-statCha', 
            'dcc-skills': 'dcc-preview-skills', 
            'dcc-catchphrase': 'dcc-preview-catchphrase' 
        };

        function updatePreview() {
            for (const [inputId, previewId] of Object.entries(textFields)) {
                const inputEl = document.getElementById(inputId);
                const previewEl = document.getElementById(previewId);
                if (!inputEl || !previewEl) continue;

                if (inputId === 'dcc-crawlerLevel') previewEl.textContent = LEVEL ${inputEl.value || '1'};
                else if (inputId === 'dcc-crawlerSubclass') previewEl.textContent = dom.hasClass.checked ? (inputEl.value || 'Subclass not specified') : '';
                else previewEl.textContent = inputEl.value || inputEl.placeholder;
            }

            const imageUrl = dom.imageUrl.value;
            const zoom = dom.imageZoom.value;
            const panX = dom.imagePanX.value;
            const panY = dom.imagePanY.value;
            const isFullBg = dom.fullBgImage.checked && imageUrl;

            dom.imageAdjustControls.style.display = imageUrl ? 'block' : 'none';
            
            if (isFullBg) {
                dom.cardPreview.style.backgroundImage = url(${imageUrl});
                dom.cardPreview.style.backgroundSize = ${zoom}%;
                dom.cardPreview.style.backgroundPosition = ${panX}% ${panY}%;
                dom.imageContainer.style.display = 'block';
                dom.imageContainer.style.backgroundColor = 'transparent';
                dom.cardPreview.classList.add('dcc-full-bg-active');
                dom.cardContentWrapper.style.backgroundColor = 'transparent';
            } else {
                dom.cardPreview.style.backgroundImage = 'none';
                dom.imageContainer.style.display = 'block';
                dom.imageContainer.style.backgroundImage = imageUrl ? url(${imageUrl}) : 'none';
                dom.imageContainer.style.backgroundColor = imageUrl ? '' : '#d1d5db';
                dom.imageContainer.style.backgroundSize = ${zoom}%;
                dom.imageContainer.style.backgroundPosition = ${panX}% ${panY}%;
                dom.cardPreview.classList.remove('dcc-full-bg-active');
                dom.cardContentWrapper.style.backgroundColor = '#f5f0e1';
            }

            const partyInput = document.getElementById('dcc-party');
            let partyContent = partyInput.value;
            if (dom.hasPet.checked) {
                const petNameInput = document.getElementById('dcc-petName');
                const petName = petNameInput.value || petNameInput.placeholder;
                if (petName) {
                    const companionString = Companion: ${petName};
                    partyContent = partyContent ? ${partyContent}\n${companionString} : companionString;
                }
                const showPetImage = dom.addPetImage.checked;
                const petImageUrl = dom.petImageUrl.value;
                dom.previewPetImage.style.display = showPetImage ? 'block' : 'none';
                if(showPetImage) {
                    dom.previewPetImage.style.backgroundImage = petImageUrl ? url(${petImageUrl}) : 'none';
                }
            } else {
                 dom.previewPetImage.style.display = 'none';
            }
            document.getElementById('dcc-preview-party').textContent = partyContent || partyInput.placeholder || 'No party or companion listed.';
        }

        const allInputIds = [...Object.keys(textFields), 'dcc-party', 'dcc-petName', 'dcc-imageZoom', 'dcc-imagePanX', 'dcc-imagePanY'];
        allInputIds.forEach(id => document.getElementById(id)?.addEventListener('input', updatePreview));
        
        function handleImageUpload(event, targetInput) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    targetInput.value = e.target.result;
                    updatePreview();
                };
                reader.readAsDataURL(file);
            }
        }

        dom.imageUpload.addEventListener('change', (e) => handleImageUpload(e, dom.imageUrl));
        dom.petImageUpload.addEventListener('change', (e) => handleImageUpload(e, dom.petImageUrl));
        
        dom.hasClass.addEventListener('change', () => { dom.subclassDetails.style.display = dom.hasClass.checked ? 'block' : 'none'; updatePreview(); });
        dom.hasPet.addEventListener('change', () => { 
            const isChecked = dom.hasPet.checked;
            dom.petDetails.style.display = isChecked ? 'flex' : 'none';
            if (!isChecked) {
                dom.addPetImage.checked = false;
                dom.petImageUrlContainer.style.display = 'none';
            }
            updatePreview(); 
        });
        dom.addPetImage.addEventListener('change', () => { dom.petImageUrlContainer.style.display = dom.addPetImage.checked ? 'block' : 'none'; updatePreview(); });
        dom.fullBgImage.addEventListener('change', updatePreview);
        document.getElementById('dcc-resetImageBtn').addEventListener('click', () => {
            dom.imageZoom.value = 100; dom.imagePanX.value = 50; dom.imagePanY.value = 50; updatePreview();
        });

        document.getElementById('dcc-downloadBtn').addEventListener('click', () => { html2canvas(dom.cardPreview, { useCORS: true, backgroundColor: null }).then(canvas => { const link = document.createElement('a'); link.download = 'dungeon-crawler-card.png'; link.href = canvas.toDataURL('image/png'); link.click(); }); });
        
        updatePreview();
    };

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupDccGenerator);
    } else {
        setupDccGenerator();
    }
</script>